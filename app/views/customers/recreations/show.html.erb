<% meta_tags_each_page(
  @recreation.title,
  @recreation.description,
  nil,
  @recreation.recreation_images&.sliders&.first&.image&.to_s
)%>

<main class="detail">
  <div class="container pt-2">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <%= link_to 'トップ', root_path %>
        </li>
        <li class="breadcrumb-item">
          <%= link_to '一覧', customers_recreations_path %>
        </li>
        <% category_tag = @recreation.tags.categories&.first %>
        <% if category_tag.present? %>
          <li class="breadcrumb-item">
            <span class="text-secondary"><%= @recreation.category_text %></span>
          </li>
        <% end %>
        <li class="breadcrumb-item active">
          <span class="text-secondary"><%= @recreation.title %></span>
        </li>
      </ol>
    </nav>
  </div>

  <article class="container py-4 px-0">
    <div class="row">
      <div class="col-md-7">
        <div class="card">
          <div class="card-body p-0">
            <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
              <div class="carousel-inner">
                <% if @recreation.youtube_id? %>
                  <div id="youtubeSection" class="carousel-item active" data-interval="false">
                    <div class="ratio ratio-16x9">
                      <iframe src="https://www.youtube.com/embed/<%= @recreation.youtube_id %>" allowfullscreen></iframe>
                    </div>
                  </div>
                <% end %>
                <% @recreation.recreation_images.sliders.each_with_index do |file, i| %>
                  <div class="carousel-item <%= 'active' if !@recreation.youtube_id? && i == 0 %>" data-bs-interval="10000">
                    <%= image_tag file&.image.to_s, class: 'd-block w-100 custom-height' %>
                  </div>
                <% end %>
              </div>
              <% if @recreation.youtube_id? %>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
              <% end %>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>

          </div>
          <div class="card-body recreation">
            <div class="d-flex flex-column-reverse">
              <h1 class="card-title"><%= @recreation.title %></h1>
              <p class="card-subtitle"><%= @recreation.second_title %></p>
            </div>
            <div class="d-flex">
              <%= link_to customers_recreation_evaluations_path(@recreation.id), class: "link-text d-flex me-3" do %>
                <%= image_pack_tag 'evaluation_count.svg', width: 18, height: 14 %>
                <p class="ms-1">レビュー数<%= @evaluations.size %>件</p>
              <% end %>
              <div class="link-text d-flex me-3">
                <%= image_pack_tag 'number_of_held.svg', width: 14, height: 18 %>
                <p class="ms-1 mb-0">開催回数<%= @recreation.number_of_recreations_held %>件</p>
              </div>
              <% if user_signed_in? %>
                <% if current_user.role.customer? %>
                  <div class="me-1 favorite-icon" id='favoriteIcon_<%= @recreation.id %>'></div>
                  <p>お気に入りに追加</p>
                <% end %>
              <% end %>
            </div>
            <div class="category-tags pb-2">
              <%= tag_to_html(@recreation, false) %>
            </div>
            <div class="description border-top py-3">
              <h3>このようなことをやります</h3>
              <p><%= simple_format @recreation.description %></p>
            </div>
            <div class="border-top py-3">
              <h3>当日の流れとタイムスケジュール</h3>
              <p><%= simple_format @recreation.flow_of_day %></p>
            </div>
            <% unless user_signed_in? %>
              <div class="border-top py-3">
                <h3>このレクリエーションの講師</h3>
                <%= link_to new_user_session_path do %>
                  <%= image_pack_tag 'partner-info.png', class: 'w-100' %>
                <% end %>
              </div>
            <% end %>

            <% if user_signed_in? %>
              <div class="r-t-a">
                <h3>お借りしたいもの</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text"><%= simple_format @recreation.borrow_item %></p>
              </div>
              <div class="r-t-a">
                <h3>持ち込むもの</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text "><%= simple_format @recreation.bring_your_own_item %></p>
              </div>
              <div class="r-t-a">
                <h3>その他</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text "><%= simple_format @recreation.extra_information %></p>
              </div>
              <% if @recreation.profile.present? %>
                <div>
                  <h3>このレクリエーションの講師</h3>
                  <div class="row align-items-center">
                    <div class="col-md-4 text-center">
                      <%= image_tag @recreation.profile_image&.to_s, class: "align-self-center rounded-circle", width: 90 %>
                      <h4><%= @recreation.profile_name %></h4>
                    </div>
                    <div class="col-md-8">
                      <h4 class="instructor-position h5"><%= @recreation.profile_title %></h4>
                      <p class="instructor-content"><%= simple_format @recreation.profile_description %></p>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div id="leftInfo" class="sticky-md-top">
          <div class="card ">
            <div class="card-body">
              <% if @recreation.is_public_price %>
                <h3 class="font-24">
                  <%= price_pipe(@recreation.price, current_user) %><span> / 1回あたり</span>
                </h3>
                <% if @recreation.material_price.present? && @recreation.material_price != 0 %>
                  <p>
                    <%= "材料費 #{price_pipe(@recreation.material_price, current_user)} / 1名あたり" %>
                  </p>
                <% end %>
              <% else %>
                <h3 class="title-b font-20">料金はお問い合わせください</h3>
                <div class="text-muted">レク料金は非公開となっています。<br>知りたい場合はお問い合わせをしてください。</div>
              <% end %>
              <div class="border border-bottom-0 p-3">
                <h4 class="title">参加人数制限 <%= recreation_capacity(@recreation.capacity) %></h4>
                <div class="text-muted">※目安30名様に1名のスタッフ様のサポートをお願い致します。</div>
              </div>
              <div class="border border-bottom-0 p-3">
                <h4 class="title">所要時間 <%= @recreation.minutes %>分</h4>
                <div class="text-muted">※ご要望に合わせてご相談が可能です。基本時間のため、ご要望にあわせて調節が可能です。</div>
              </div>
              <div class="border p-3">
                <h4 class="title">対象者目安</h4>
                <% @recreation.tags.targets.each do |target| %>
                  <div class="text-muted">・<%= target.name %></div>
                <% end %>
              </div>
              <% if @recreation.kind.visit? && @recreation.recreation_prefectures.exists? %>
                <div class="border p-3">
                  <h4 class="title">対象エリア</h4>
                  <% @recreation.recreation_prefectures.pluck(:name).uniq.each do |prefecture_name| %>
                    <div class="text-muted">・<%= prefecture_name %></div>
                  <% end %>
                </div>
              <% end %>

              <div class="action-area">
                <% if user_signed_in? %>
                  <!-- 0円の場合はslackに飛ばしで営業が対応 -->
                  <% if @recreation.is_public_price %>
                    <%= link_to '相談・依頼する', new_customers_recreation_order_path(@recreation.id), class: "btn-cpr" %>
                  <% else %>
                    <!-- React呼び出し -->
                    <div id="ConsultRecreation" data-recreationId=<%= @recreation.id %>></div>
                  <% end %>
                <% else %>
                  <%= link_to 'ログインして相談・依頼する', new_user_session_path, class: "btn-cpr" %>
                <% end %>
              </div>
            </div>

            <%= render 'shared/home/order_flow' %>
          </div>
        </div>
      </div>
    </div>
    <div class="md-row">
      <div class="col-md-11">
        <div class="row">
        <h5 class="title-b font-18 mt-3 mb-0"><%= @evaluations.size %>件のレビュー</h5>
          <% @evaluations.latest(3).each do |evaluation| %>
            <div class="col-md-4 position-relative">
              <div class="evaluation-card col-11 border rounded shadow mt-4 px-2 w-100">
                <div class="p-3">
                  <h6 class="text-black">
                  <span>
                    <%= image_pack_tag 'evaluation_icon.svg', id: "hamburger", class: "logo-navbar", width: "30", height: "30" %>
                  </span><%= evaluation.report.order.user.company.facility_name %>(<%= evaluation.report.order.user.company.genre_text %>)</h6>
                  <p class="my-2 text-black"><%= evaluation.message.truncate(120, omission: '...') %></p>
                  <p class="evaluation-date mb-3 position-absolute bottom-0"><%= evaluation.created_at.strftime('%Y/%m/%d') %></p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <div class="my-3 p-2 d-inline-block rounded text-dark" style="background-color: #f5f2f0;">
        <%= link_to '全てのレビューを見る', customers_recreation_evaluations_path(@recreation.id), class: "fw-bold", style: "color: #343a40; text-decoration: none;" %>
      </div>
    </div>
  </article>
</main>

<!-- NOTE: trigger経由でpriceModalを発火 -->
<div id="priceModalTrigger" data-bs-toggle="modal" data-bs-target="#priceModal" class="d-none"></div>
<!-- NOTE: reactで制御しているが、要素をnestさせるとclick不可の状態に陥ることあるので、railsで使っている。 -->
<div id="priceModal" class="modal fade" tabindex="-1" aria-labelledby="contact-price-modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">料金をお問い合わせしました</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>「<%= @recreation.title %>」の料金をお問い合わせしました。エブリ・プラスのスタッフからメールで返信致します。少々お待ちください。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cprimary rounded-pill text-white" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>
