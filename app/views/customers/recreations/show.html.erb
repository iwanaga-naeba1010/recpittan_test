<% meta_tags_each_page(
  @recreation.title,
  @recreation.description,
  nil,
  @recreation.recreation_images&.sliders&.first&.image&.to_s
)%>

<main class="detail">
  <div class="container pt-2">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <%= link_to 'トップ', root_path %>
        </li>
        <li class="breadcrumb-item">
          <%= link_to '一覧', customers_recreations_path %>
        </li>
        <% category_tag = @recreation.tags.categories&.first %>
        <% if category_tag.present? %>
          <li class="breadcrumb-item">
            <!-- TODO: Tag.categories.firstを表示 + ransack入れる -->
            <%= link_to @recreation.category_text, customers_recreations_path(q: { category_eq: @recreation.category.value }) %>
          </li>
        <% end %>
        <li class="breadcrumb-item active">
          <!-- TODO: Tag.categories.firstを表示 + ransack入れる -->
          <span class="text-secondary"><%= @recreation.title %></span>
        </li>
      </ol>
    </nav>
  </div>

  <article class="container py-4 px-0">
    <div class="row">
      <div class="col-md-7">
        <div class="card">
          <div class="card-body p-0">
            <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
              <div class="carousel-inner">
                <% if @recreation.youtube_id? %>
                  <div id="youtubeSection" class="carousel-item active" data-interval="false">
                    <div class="ratio ratio-16x9">
                      <iframe src="https://www.youtube.com/embed/<%= @recreation.youtube_id %>" allowfullscreen></iframe>
                    </div>
                  </div>
                <% end %>
                <% @recreation.recreation_images.sliders.each_with_index do |file, i| %>
                  <div class="carousel-item <%= 'active' if !@recreation.youtube_id? && i == 0 %>" data-bs-interval="10000">
                    <%= image_tag file&.image.to_s, class: 'd-block w-100 custom-height' %>
                  </div>
                <% end %>
              </div>
              <% if @recreation.youtube_id? %>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
              <% end %>
              <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>

          </div>
          <div class="card-body recreation">
            <div class="d-flex flex-column-reverse">
              <h1 class="card-title"><%= @recreation.title %></h1>
              <h2 class="card-subtitle"><%= @recreation.second_title %></h2>
            </div>
            <div class="category-tags pb-2">
              <%= tag_to_html(@recreation, false) %>
            </div>
            <div class="description border-top py-3">
              <h3>このようなことをやります</h3>
              <p><%= simple_format @recreation.description %></p>
            </div>
            <div class="border-top py-3">
              <h3>当日の流れとタイムスケジュール</h3>
              <p><%= simple_format @recreation.flow_of_day %></p>
            </div>
            <% unless user_signed_in? %>
              <div class="border-top py-3">
                <h3>このレクリエーションの講師</h3>
                <%= link_to new_user_session_path do %>
                  <%= image_pack_tag 'partner-info.png', class: 'w-100' %>
                <% end %>
              </div>
            <% end %>

            <% if user_signed_in? %>
              <div class="r-t-a">
                <h3>お借りしたいもの</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text"><%= simple_format @recreation.borrow_item %></p>
              </div>
              <div class="r-t-a">
                <h3>持ち込むもの</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text "><%= simple_format @recreation.bring_your_own_item %></p>
              </div>
              <div class="r-t-a">
                <h3>その他</h3>
                <div class="text-muted">※状況にあわせて、変わる可能性がございます。</div>
                <p class="item-text "><%= simple_format @recreation.extra_information %></p>
              </div>
              <div class="">
                <h3>このレクリエーションの講師</h3>
                <div class="row align-items-center">
                  <div class="col-md-4 text-center">
                    <%= image_tag @recreation.profile_image&.to_s, class: "align-self-center rounded-circle", width: 90 %>
                    <h4><%= @recreation.profile_name %></h4>
                  </div>
                  <div class="col-md-8">
                    <h4 class="instructor-position h5"><%= @recreation.profile_title %></h4>
                    <p class="instructor-content"><%= simple_format @recreation.profile_description %></p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div id="leftInfo" class="sticky-md-top">
          <div class="card ">
            <div class="card-body">
              <% if user_signed_in? %>
                <% if @recreation.is_public_price %>
                  <h3 class="font-24">
                    <%= price_pipe(@recreation.price, current_user) %><span> / 1回あたり</span>
                  </h3>
                  <% if @recreation.material_price.present? && @recreation.material_price != 0 %>
                    <p>
                      <%= "材料費 #{price_pipe(@recreation.material_price, current_user)} / 1名あたり" %>
                    </p>
                  <% end %>
                <% else %>
                  <h3 class="title-b font-20">料金はお問い合わせください</h3>
                  <div class="text-muted">レク料金は非公開となっています。<br>知りたい場合はお問い合わせをしてください。</div>
                <% end %>
              <% else %>
                <h3 class="title-b font-20">会員限定</h3>
                <div class="text-muted">料金をご覧になるには会員登録が必要です。<br>ログインすると表示されます。</div>
              <% end %>
              <div class="border border-bottom-0 p-3">
                <h4 class="title">所要時間 <%= @recreation.minutes %>分</h4>
                <div class="text-muted">※ご要望に合わせてご相談が可能です。基本時間のため、ご要望にあわせて調節が可能です。</div>
              </div>
              <div class="border p-3">
                <h4 class="title">対象者目安</h4>
                <% @recreation.tags.targets.each do |target| %>
                  <div class="text-muted">・<%= target.name %></div>
                <% end %>
              </div>

              <div class="action-area">
                <% if user_signed_in? %>
                  <!-- 0円の場合はslackに飛ばしで営業が対応 -->
                  <% if @recreation.is_public_price %>
                    <%= link_to '相談・依頼する', new_customers_recreation_order_path(@recreation.id), class: "btn-cpr" %>
                  <% else %>
                    <!-- React呼び出し -->
                    <div id="ConsultRecreation" data-recreationId=<%= @recreation.id %>></div>
                  <% end %>
                <% else %>
                  <%= link_to 'ログインして相談・依頼する', new_user_session_path, class: "btn-cpr" %>
                <% end %>
              </div>
            </div>

            <%= render 'shared/home/order_flow' %>
          </div>
        </div>
      </div>
    </div>
    <div class="md-row">
      <div class="col-md-11">
        <div class="row">
        <h5 class="mt-3 mb-0"><%= @evaluations.size %>件のレビュー</h5>
          <% @evaluations.each do |evaluation| %>
            <div class="col-md-4 position-relative">
              <div class="evaluation-card col-11 border rounded shadow mt-4 px-2 w-100">
                <div class="p-3">
                  <h6 class="text-black">
                  <span>
                  <svg width="36" height="28" viewBox="0 0 36 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M4 28.0005C1.79086 28.0005 0 26.2097 0 24.0005V15.658C0 6.95051 1.64928 3.79596 8.45027 0.219596C9.20354 -0.176517 10.1258 -0.0239489 10.7314 0.574089L11.6596 1.49078C12.6986 2.51697 12.308 4.25571 11.0115 4.92801C7.21347 6.89762 6.48004 9.28821 6.48004 15.658H11.4287C13.6378 15.658 15.4287 17.4489 15.4287 19.658V24.0005C15.4287 26.2097 13.6378 28.0005 11.4287 28.0005H4ZM24.5713 28.0006C22.3622 28.0006 20.5713 26.2097 20.5713 24.0006V15.658C20.5713 6.95052 22.2206 3.79598 29.0216 0.219612C29.7749 -0.176501 30.6972 -0.0239332 31.3027 0.574104L32.2309 1.4908C33.2699 2.51699 32.8793 4.25573 31.5829 4.92803C27.7848 6.89764 27.0514 9.28823 27.0514 15.658H32C34.2092 15.658 36 17.4489 36 19.658V24.0006C36 26.2097 34.2092 28.0006 32 28.0006H24.5713Z" fill="#E83E8C"/>
                  </svg>
                  </span><%= evaluation.report.order.user.company.facility_name %></h6>
                  <p class="my-2 text-black"><%= evaluation.message.truncate(120, omission: '...') %></p>
                  <p class="evaluation-date mb-3 position-absolute bottom-0"><%= evaluation.created_at.strftime('%Y/%m/%d') %></p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </article>
</main>

<!-- NOTE: trigger経由でpriceModalを発火 -->
<div id="priceModalTrigger" data-bs-toggle="modal" data-bs-target="#priceModal" class="d-none"></div>
<!-- NOTE: reactで制御しているが、要素をnestさせるとclick不可の状態に陥ることあるので、railsで使っている。 -->
<div id="priceModal" class="modal fade" tabindex="-1" aria-labelledby="contact-price-modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">料金をお問い合わせしました</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>「<%= @recreation.title %>」の料金をお問い合わせしました。エブリ・プラスのスタッフからメールで返信致します。少々お待ちください。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cprimary rounded-pill text-white" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>
