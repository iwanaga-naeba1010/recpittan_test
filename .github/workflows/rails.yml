env:
  RUBY_VERSION: 3.3.6
  RAILS_ENV: test
  POSTGRES_USER: postgres
  PGHOST: localhost
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: ep_matching_test
  MAIL_SENDER_FROM: no-reply@ep.net
  SLACK_WEBHOOK: https://hooks.slack.com/services/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
  SLACK_USERNAME: github_actions_bot
  SLACK_CHANNEL: product_matching_system
  AWS_ACCESS_KEY_ID: AKIASN7APX6NOANAVIJ2
  AWS_BUCKET: matching-system-staging
  AWS_REGION: ap-northeast-1
  AWS_SECRET_ACCESS_KEY: 0Mf2Hjc4SUuOZ5dfAxPZI/Q4GrByML5hEA30Yl+p
  DOMAIN: http://localhost:3000
  ENCRYPTION_PRIMARY_KEY: uuOdXEZGRdODjRTtyMoz21KGyYUKTQYX
  ENCRYPTION_DETERMINISTIC_KEY: cQDGBHptxP4rDwAOYB8J98r6oSgCwiGN
  ENCRYPTION_KEY_DERIVATION_SALT: YcYlIiTtdOBvrpdfWkDlcBx9lr0sMe2Y
  GOOGLE_PRIVATE_KEY: -----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC4Kz0qTFVbYui6\nJH+GKd+a/jKcrh8OZEp3HKb1bWNvIuIfpArBSsN5zQ6dHMNn8hb/3zvijM/vOiJW\noEirtZsFQN8ljKfzXZydz/Wou8I5vyqVzsF1CgUMf3m4GuTpBf5ZdnztwsKVTqsX\nIFTVnfNQgsXMed4Ke7L4his/HxtjcFXQ8/Rcx7wIbA94BPb9wmaOzfBR/E60jepk\nBtdt3R/yZU1B2YaS7k6DuXQ7dyhprfMii+qE6MdbhSxM8paMH/Zk4BUGFM0ar4eC\naEcMQyjTI1zn4bQnD+58OS5lC7+de/U19VLSXhMEmgxv69rcErbbcbkerz32YtzQ\nVbXEzVHFAgMBAAECggEAAS9Qn+eJ+MuZf8gEsr7+D2RJYrN8UOiSJOmyDpPjzOah\nvB520MIA1wsoFyGHF4/rJG88Dpzy3GyaMGPv7Ls5sOdWnPK6wEzckWeWwVhPL2OW\nnyuz2TZ2oaipqDd1+MqvwT6EXb6w4uvFkGBXCfnMT+NmgdK49UuofC3lNpNnUG6m\nE4NS0doUFi9ZhwVHgkMrveWXE7VB+swZd2GaV21nO6RIIJ2AiFKaofJ6AE1JumHV\n9QEDdnyX2rU7biFJT0l++XMGwivE54xBaMtTGyqS1zRgy9j+28W6ruXA8irxWDpQ\ndyFR4FAmiLLtWlrAC+qT8oi3TReqXD3YxlYBRWxJBwKBgQDySd+Jd4bhOZSZVfAZ\n6598tiwt8LXEeK4V2xGv6xYEf2B6nR8n7I2wwHyVCGAS2paxgZxyj4zt6tTOpqF4\nj/pfmKdkyAzPFe5F5+v+ZHH4Hz0SSJvMokaKEhk7JM6Clu8IEgrP6Oe/CSU8V+IK\nTRXZbt9K4nZirTcX0k6Lm7ODtwKBgQDCl10u8zdhLNlZ4dlAb66JAhi5M/9SgVfC\nGjI6E0gA0Wj6FlywfbAq8AtHnpkdKZr/7VRyA6xgKwIPKDegKJ7oj224573vRm4W\nlgzxc32hPWeExNIfXDT8TXB5miMbMnFBzP21SnotAwsBLclDevifdLkSC2be+YP9\n+jRVmf2uYwKBgQCbyWok/qjISnjEuyAd2oX67zuq8lo9kQcGYIyX24WVsL09Oafd\nyNk2LB4uyWrU1J4OVnNcqfaIx/S7RyMN3S20p/gB8itiQAysADqaoMUzMArZpbwf\nsLvAbXCxubHa/+eD/e3bzzqrd9rsWOmri/Mfko2andBXFF8XPw9n7t5XMwKBgGJN\nvVF+pTd+RL9XjT00LmQgnwTQ8+dmWENCoKUeIH3pTLMqoOC4XksSwWAJCyjkX91y\ns/p1SJu8nmmx04ghfUXXT4Ld7+H1HqBiZV+FDK5sKuOz2sLk/g+Hv45vA9U1gmnP\neUwgt+ANbX3G96oTcY58lRI8mFeEjd28jLvB85opAoGAOIncn1S7tcGqwo10AtNE\nYTQAGmwwTp/KyGE2dCh9BG2NsflLObYL6c1InGPFV3zWaJ8W6vC/8XSZn4FNkVb1\nSRS67QhptTnIJ1GzTtZ8ZElRo0c7sfWHX6yfAoZ8/WdepA4VljEIdaPIzlDG9MhP\nSk7BcYBfs2QpMuADFEBZiJ8=\n-----END PRIVATE KEY-----\n
  GOOGLE_CLIENT_EMAIL: 190051669742-compute@developer.gserviceaccount.com

name: Lint check
on: [push]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - name: Set up Ruby 3.3.6
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.6
          bundler-cache: true
      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: bundle install
        run: |
          gem install bundler
          bundle install --jobs 4 --retry 3 --path vendor/bundle
      - name: yarn install
        run: yarn install --check-files
      - name: Run rubocop
        run: bundle exec rubocop

      - name: Run brakeman
        run: bundle exec brakeman

      - name: Run rails best practices
        run: bundle exec rails_best_practices -e node_modules

      - name: Run eslint
        run: yarn lint

      - name: Run slim-lint
        run: bundle exec slim-lint app/views

      #-- Slack通知 --#
      # 成功
      - name: Slack Notification on Success
        if: ${{ success() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: Deploy Success
          SLACK_COLOR: good

      # 失敗
      - name: Slack Notification on Failure
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: Deploy Failure
          SLACK_COLOR: danger

  rspec:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:latest
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v2.3.4
      - name: Set up Ruby 3.3.6
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3.6
          bundler-cache: true
      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: yarn install
        run: yarn install --check-files

      - name: bundle install
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: bundle-${{ hashFiles('**/Gemfile.lock') }}

      - name: Setup Bundles
        run: |
          gem install bundler
          bundle install

      - name: Setup database
        env:
          RAILS_ENV: ${{ env.RAILS_ENV }}
          PGHOST: ${{ env.PGHOST }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          cp ./config/database.yml.ci ./config/database.yml
          bundle exec rake db:create RAILS_ENV=test
          bundle exec rails db:create RAILS_ENV=test
          bundle exec rails db:migrate RAILS_ENV=test

      # Chrome driver
      - name: Setup chrome driver (for Selenium)
        uses: nanasess/setup-chromedriver@master

      - name: Run rspec
        run: |
            bundle exec rspec

      #-- Slack通知 --#
      # 成功
      - name: Slack Notification on Success
        if: ${{ success() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: Deploy Success
          SLACK_COLOR: good

      # 失敗
      - name: Slack Notification on Failure
        if: ${{ failure() }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: Deploy Failure
          SLACK_COLOR: danger
